<workflow>
  <meta>
    <name>create-story</name>
    <description>Create comprehensive developer-ready story files from epics with full context</description>
  </meta>

  <inputs>
    <input name="epics" required="true">Epic and story definitions</input>
    <input name="prd" required="true">Product requirements document</input>
    <input name="architecture" required="true">Architecture document</input>
    <input name="ux_design_spec" required="false">UX design specification</input>
    <input name="story_template" required="true">Story file template</input>
    <input name="story_checklist" required="true">Story validation checklist</input>
  </inputs>

  <source_documents>
## Epics

{epics}

## PRD

{prd}

## Architecture

{architecture}

## UX Design Specification

{!ux_design_spec}

## Story Template

{story_template}

## Story Checklist

{story_checklist}
  </source_documents>

  <critical>üî• CRITICAL MISSION: You are creating the ULTIMATE story context engine that prevents LLM developer mistakes, omissions or
    disasters! üî•</critical>
  <critical>Your purpose is NOT to copy from epics - it's to create a comprehensive, optimized story file that gives the DEV agent
    EVERYTHING needed for flawless implementation</critical>
  <critical>COMMON LLM MISTAKES TO PREVENT: reinventing wheels, wrong libraries, wrong file locations, breaking regressions, ignoring UX,
    vague implementations, lying about completion, not learning from past work</critical>
  <critical>üö® EXHAUSTIVE ANALYSIS REQUIRED: You must thoroughly analyze ALL artifacts to extract critical context - do NOT be lazy or skim!
    This is the most important function in the entire development process!</critical>
  <critical>üî¨ UTILIZE SUBPROCESSES AND SUBAGENTS: Use research subagents, subprocesses or parallel processing if available to thoroughly
    analyze different artifacts simultaneously and thoroughly</critical>
  <critical>‚ùì SAVE QUESTIONS: If you think of questions or clarifications during analysis, save them for the end after the complete story is
    written</critical>
  <critical>üéØ ZERO USER INTERVENTION: Process is fully automated - all data is pre-injected</critical>

  <step n="1" goal="Determine target story from sprint status">
    <action>From {sprint_status}, find the FIRST story (in order) where:
      - Key matches pattern: number-number-name (e.g., "1-2-user-auth")
      - NOT an epic key (epic-X) or retrospective (epic-X-retrospective)
      - Status value equals "backlog"
    </action>

    <check if="no backlog story found">
      <output>üìã No backlog stories found - All stories are either already created, in progress, or done.</output>
      <action>HALT</action>
    </check>

    <action>Extract from found story key (e.g., "1-2-user-authentication"):
      - epic_num: first number before dash (e.g., "1")
      - story_num: second number after first dash (e.g., "2")
      - story_title: remainder after second dash (e.g., "user-authentication")
    </action>
    <action>Set {{story_id}} = "{{epic_num}}.{{story_num}}"</action>
    <action>Store story_key for later use (e.g., "1-2-user-authentication")</action>

    <!-- Mark epic as in-progress if this is first story -->
    <check if="this is first story in epic ({{epic_num}}-1-*)">
      <action>If epic-{{epic_num}} status is "backlog" or "contexted" ‚Üí update to "in-progress"</action>
      <check if="epic status is 'done'">
        <output>üö´ ERROR: Cannot create story in completed epic - Epic {{epic_num}} is marked as 'done'</output>
        <action>HALT</action>
      </check>
      <output>üìä Epic {{epic_num}} status updated to in-progress</output>
    </check>
  </step>

  <step n="2" goal="Load and analyze core artifacts">
    <critical>üî¨ EXHAUSTIVE ARTIFACT ANALYSIS - This is where you prevent future developer fuckups!</critical>

    <!-- Load all available content through discovery protocol -->
    <invoke-protocol
      name="discover_inputs" />
    <note>Available content: {epics_content}, {prd_content}, {architecture_content}, {ux_content},
    {project_context}</note>

    <!-- Analyze epics file for story foundation -->
    <action>From {epics_content}, extract Epic {{epic_num}} complete context:</action> **EPIC ANALYSIS:** - Epic
    objectives and business value - ALL stories in this epic for cross-story context - Our specific story's requirements, user story
    statement, acceptance criteria - Technical requirements and constraints - Dependencies on other stories/epics - Source hints pointing to
    original documents <!-- Extract specific story requirements -->
    <action>Extract our story ({{epic_num}}-{{story_num}}) details:</action> **STORY FOUNDATION:** - User story statement
    (As a, I want, so that) - Detailed acceptance criteria (already BDD formatted) - Technical requirements specific to this story -
    Business context and value - Success criteria <!-- Previous story analysis for context continuity -->
    <check if="story_num > 1">
      <action>Load previous story file: .codemachine/artifacts/stories/{{epic_num}}-{{previous_story_num}}-*.md</action> **PREVIOUS STORY INTELLIGENCE:** -
    Dev notes and learnings from previous story - Review feedback and corrections needed - Files that were created/modified and their
    patterns - Testing approaches that worked/didn't work - Problems encountered and solutions found - Code patterns established <action>Extract
    all learnings that could impact current story implementation</action>
    </check>

    <!-- Git intelligence for previous work patterns -->
    <check
      if="previous story exists AND git repository detected">
      <action>Get last 5 commit titles to understand recent work patterns</action>
      <action>Analyze 1-5 most recent commits for relevance to current story:
        - Files created/modified
        - Code patterns and conventions used
        - Library dependencies added/changed
        - Architecture decisions implemented
        - Testing approaches used
      </action>
      <action>Extract actionable insights for current story implementation</action>
    </check>
  </step>

  <step n="3" goal="Architecture analysis for developer guardrails">
    <critical>üèóÔ∏è ARCHITECTURE INTELLIGENCE - Extract everything the developer MUST follow!</critical> **ARCHITECTURE DOCUMENT ANALYSIS:** <action>Systematically
    analyze architecture content for story-relevant requirements:</action>

    <!-- Load architecture - single file or sharded -->
    <check if="architecture file is single file">
      <action>Load complete {architecture_content}</action>
    </check>
    <check if="architecture is sharded to folder">
      <action>Load architecture index and scan all architecture files</action>
    </check> **CRITICAL ARCHITECTURE EXTRACTION:** <action>For
    each architecture section, determine if relevant to this story:</action> - **Technical Stack:** Languages, frameworks, libraries with
    versions - **Code Structure:** Folder organization, naming conventions, file patterns - **API Patterns:** Service structure, endpoint
    patterns, data contracts - **Database Schemas:** Tables, relationships, constraints relevant to story - **Security Requirements:**
    Authentication patterns, authorization rules - **Performance Requirements:** Caching strategies, optimization patterns - **Testing
    Standards:** Testing frameworks, coverage expectations, test patterns - **Deployment Patterns:** Environment configurations, build
    processes - **Integration Patterns:** External service integrations, data flows <action>Extract any story-specific requirements that the
    developer MUST follow</action>
    <action>Identify any architectural decisions that override previous patterns</action>
  </step>

  <step n="4" goal="Web research for latest technical specifics">
    <critical>üåê ENSURE LATEST TECH KNOWLEDGE - Prevent outdated implementations!</critical> **WEB INTELLIGENCE:** <action>Identify specific
    technical areas that require latest version knowledge:</action>

    <!-- Check for libraries/frameworks mentioned in architecture -->
    <action>From architecture analysis, identify specific libraries, APIs, or
    frameworks</action>
    <action>For each critical technology, research latest stable version and key changes:
      - Latest API documentation and breaking changes
      - Security vulnerabilities or updates
      - Performance improvements or deprecations
      - Best practices for current version
    </action>
    **EXTERNAL CONTEXT INCLUSION:** <action>Include in story any critical latest information the developer needs:
      - Specific library versions and why chosen
      - API endpoints with parameters and authentication
      - Recent security patches or considerations
      - Performance optimization techniques
      - Migration considerations if upgrading
    </action>
  </step>

  <step n="5" goal="Create comprehensive story file">
    <critical>üìù CREATE ULTIMATE STORY FILE - The developer's master implementation guide!</critical>

    <action>Initialize from template.md and save to: .codemachine/artifacts/stories/{{epic_num}}-{{story_num}}-{{story_title}}.md</action>
    <template-output file=".codemachine/artifacts/stories/{{epic_num}}-{{story_num}}-{{story_title}}.md">story_header</template-output>

    <!-- Story foundation from epics analysis -->
    <template-output
      file=".codemachine/artifacts/stories/{{epic_num}}-{{story_num}}-{{story_title}}.md">story_requirements</template-output>

    <!-- Developer context section - MOST IMPORTANT PART -->
    <template-output file=".codemachine/artifacts/stories/{{epic_num}}-{{story_num}}-{{story_title}}.md">
    developer_context_section</template-output> **DEV AGENT GUARDRAILS:** <template-output file=".codemachine/artifacts/stories/{{epic_num}}-{{story_num}}-{{story_title}}.md">
    technical_requirements</template-output>
    <template-output file=".codemachine/artifacts/stories/{{epic_num}}-{{story_num}}-{{story_title}}.md">architecture_compliance</template-output>
    <template-output
      file=".codemachine/artifacts/stories/{{epic_num}}-{{story_num}}-{{story_title}}.md">library_framework_requirements</template-output>
    <template-output file=".codemachine/artifacts/stories/{{epic_num}}-{{story_num}}-{{story_title}}.md">
    file_structure_requirements</template-output>
    <template-output file=".codemachine/artifacts/stories/{{epic_num}}-{{story_num}}-{{story_title}}.md">testing_requirements</template-output>

    <!-- Previous story intelligence -->
    <check
      if="previous story learnings available">
      <template-output file=".codemachine/artifacts/stories/{{epic_num}}-{{story_num}}-{{story_title}}.md">previous_story_intelligence</template-output>
    </check>

    <!-- Git intelligence -->
    <check
      if="git analysis completed">
      <template-output file=".codemachine/artifacts/stories/{{epic_num}}-{{story_num}}-{{story_title}}.md">git_intelligence_summary</template-output>
    </check>

    <!-- Latest technical specifics -->
    <check if="web research completed">
      <template-output file=".codemachine/artifacts/stories/{{epic_num}}-{{story_num}}-{{story_title}}.md">latest_tech_information</template-output>
    </check>

    <!-- Project context reference -->
    <template-output
      file=".codemachine/artifacts/stories/{{epic_num}}-{{story_num}}-{{story_title}}.md">project_context_reference</template-output>

    <!-- Final status update -->
    <template-output file=".codemachine/artifacts/stories/{{epic_num}}-{{story_num}}-{{story_title}}.md">
    story_completion_status</template-output>

    <!-- CRITICAL: Set status to ready-for-dev -->
    <action>Set story Status to: "ready-for-dev"</action>
    <action>Add completion note: "Ultimate
    context engine analysis completed - comprehensive developer guide created"</action>
  </step>

  <step n="6" goal="Update sprint status and finalize">
    <action>Validate story against the Story Checklist criteria in source documents above</action>
    <action>Save story document unconditionally</action>

    <!-- Update sprint status -->
    <action>In .codemachine/artifacts/sprint-status.yaml, update development_status[{{story_key}}] from "backlog" to "ready-for-dev"</action>
    <action>Save .codemachine/artifacts/sprint-status.yaml preserving all comments and structure</action>

    <action>Report completion</action>
    <output>**üéØ ULTIMATE BMad Method STORY CONTEXT CREATED, {user_name}!**

      **Story Details:**
      - Story ID: {{story_id}}
      - Story Key: {{story_key}}
      - File: .codemachine/artifacts/stories/{{story_key}}.md
      - Status: ready-for-dev

      **Next Steps:**
      1. Review the comprehensive story in .codemachine/artifacts/stories/{{story_key}}.md
      2. **Optional Quality Competition:** Run the scrum masters `*validate-create-story` to have a fresh LLM systematically review and
      improve the story context
      3. Run dev agents `dev-story` for optimized implementation
      4. Run `code-review` when complete (auto-marks done)

      **Quality Competition Option:** The `*validate-create-story` command runs the story context through an independent LLM in fresh
      context that will:
      - Systematically re-analyze all source documents
      - Identify any misses, omissions, or improvements
      - Compete to create a more comprehensive story context
      - Present findings interactively for your approval
      - Apply improvements to create the ultimate developer implementation guide

      **The developer now has everything needed for flawless implementation!**
    </output>
  </step>

</workflow>