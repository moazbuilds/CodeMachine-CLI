---
title: "Workflow Structure"
description: "Understand what a workflow contains and how it's organized."
sidebarTitle: "Workflow Structure"
---

A workflow package is a folder containing everything CodeMachine needs to run your workflow: configuration, prompts, and workflow definitions.

<Tip>
  New to building workflows? Use the built-in [Ali workflow](#) for step-by-step guidance.
</Tip>

---

## Folder Structure

Every workflow package follows this structure:

<Tree>
  <Tree.Folder name="~/.codemachine/imports/workflow-name-codemachine" defaultOpen>
    <Tree.File name="codemachine.json" />
    <Tree.Folder name="config" defaultOpen>
      <Tree.File name="main.agents.js" />
      <Tree.File name="sub.agents.js" />
      <Tree.File name="modules.js" />
      <Tree.File name="placeholders.js" />
      <Tree.File name="agent-characters.json" />
    </Tree.Folder>
    <Tree.Folder name="templates" defaultOpen>
      <Tree.Folder name="workflows" defaultOpen>
        <Tree.File name="example.workflow.js" />
      </Tree.Folder>
    </Tree.Folder>
    <Tree.Folder name="prompts">
      <Tree.Folder name="templates" defaultOpen>
        <Tree.Folder name="workflow-name">
          <Tree.Folder name="agent-name">
            <Tree.File name="persona.md" />
            <Tree.File name="workflow.md" />
            <Tree.Folder name="chained">
              <Tree.File name="step-01.md" />
              <Tree.File name="step-02.md" />
            </Tree.Folder>
          </Tree.Folder>
          <Tree.Folder name="shared">
            <Tree.File name="step-completion.md" />
          </Tree.Folder>
        </Tree.Folder>
      </Tree.Folder>
    </Tree.Folder>
  </Tree.Folder>
</Tree>

<Note>
  A minimum workflow requires only three files: `codemachine.json`, `main.agents.js`, and a `.workflow.js` file. Everything else is optional.
</Note>

---

## Manifest File

Every workflow package must have a `codemachine.json` manifest at its root:

```json codemachine.json
{
  "name": "my-workflow",
  "version": "1.0.0",
  "description": "Optional description of your workflow"
}
```

| Field | Required | Description |
|-------|----------|-------------|
| `name` | Yes | Package identifier |
| `version` | Yes | Semantic version |
| `description` | No | Brief description |

---

## Workflow Definition

The workflow definition file (`.workflow.js`) is the core of your package. It defines what happens when someone runs your workflow.

### Minimum Workflow

A workflow only needs steps to run:

```javascript example.workflow.js
export default {
  steps: [
    resolveStep('analyst-agent'),
    resolveStep('developer-agent'),
    resolveStep('reviewer-agent'),
  ],
};
```

<Note>
  The `name` field is optional and falls back to the workflow ID if not provided.
</Note>

### Full Example

Add tracks, conditions, and autonomous mode for more control:

```javascript example.workflow.js
export default {
  name: 'My Workflow',
  autonomousMode: 'never',

  tracks: {
    question: 'Choose your project type:',
    options: {
      'simple': {
        label: 'Simple Project',
        description: 'Quick setup for small projects'
      },
      'advanced': {
        label: 'Advanced Project',
        description: 'Full configuration for complex projects'
      },
    },
  },

  conditionGroups: [
    {
      id: 'features',
      question: 'What features do you need?',
      multiSelect: true,
      conditions: {
        'has-api': { label: 'API', description: 'REST or GraphQL API' },
        'has-auth': { label: 'Auth', description: 'User authentication' },
      },
    },
  ],

  steps: [
    separator("Planning Phase"),
    resolveStep('planner-agent', {}),
    resolveStep('designer-agent', { conditions: ['has-ui'] }),
    separator("Implementation Phase"),
    resolveStep('developer-agent', {}),
    resolveModule('reviewer-agent', { loopSteps: 1 }),
  ],
};
```

### Name

The display name shown when running the workflow.

```javascript
name: 'My Workflow',
```

---

### Tracks

Tracks let users choose different workflow paths. Only one track can be selected.

```javascript
tracks: {
  question: 'Choose your project type:',
  options: {
    'landing-page': {
      label: 'Landing Page',
      description: 'Single page website'
    },
    'full-app': {
      label: 'Full Application',
      description: 'Complete web application'
    },
  },
},
```

Use tracks when you have mutually exclusive paths that significantly change the workflow.

<Tip>
  Steps can be filtered by track using the `tracks` option: `resolveStep('agent-id', { tracks: ['full-app'] })`
</Tip>

---

### Condition Groups

Conditions are feature toggles that enable or disable specific steps. Unlike tracks, multiple conditions can be selected.

```javascript
conditionGroups: [
  {
    id: 'features',
    question: 'What features do you need?',
    multiSelect: true,
    conditions: {
      'has-api': { label: 'API', description: 'REST or GraphQL API' },
      'has-auth': { label: 'Auth', description: 'User authentication' },
      'has-db': { label: 'Database', description: 'Database integration' },
    },
  },
],
```

#### Nested Conditions

Conditions can have children that appear based on parent selection:

```javascript
conditionGroups: [
  {
    id: 'deployment',
    question: 'Where will you deploy?',
    multiSelect: false,
    conditions: {
      'cloud': { label: 'Cloud', description: 'AWS, GCP, or Azure' },
      'self-hosted': { label: 'Self-hosted', description: 'Your own servers' },
    },
    children: {
      'cloud': {
        question: 'Which cloud provider?',
        multiSelect: false,
        conditions: {
          'aws': { label: 'AWS', description: 'Amazon Web Services' },
          'gcp': { label: 'GCP', description: 'Google Cloud Platform' },
        },
      },
    },
  },
],
```

#### Track-Specific Conditions

Condition groups can be limited to specific tracks:

```javascript
conditionGroups: [
  {
    id: 'advanced-features',
    question: 'Select advanced features:',
    multiSelect: true,
    tracks: ['full-app'],  // Only shown when 'full-app' track is selected
    conditions: {
      'microservices': { label: 'Microservices', description: 'Service-based architecture' },
    },
  },
],
```

---

### Steps

Steps define the sequence of agents that execute. Each step runs one agent.

```javascript
steps: [
  separator("Planning Phase"),
  resolveStep('planner-agent', {}),
  resolveStep('designer-agent', { conditions: ['has-ui'] }),
  separator("Implementation Phase"),
  resolveStep('developer-agent', {}),
  resolveModule('reviewer-agent', { loopSteps: 1 }),
],
```

#### Step Types

| Function | Description |
|----------|-------------|
| `resolveStep('agent-id', options)` | Run a main agent |
| `resolveModule('module-id', options)` | Run a module (can loop back) |
| `separator("Phase Name")` | Visual separator in the timeline |

---

### Step Options

Configure how each step behaves:

| Option | Type | Description |
|--------|------|-------------|
| `engine` | `'claude' \| 'codex'` | AI engine to use |
| `model` | `string` | Specific model |
| `interactive` | `boolean` | Wait for user input between prompts |
| `executeOnce` | `boolean` | Run only once (skip on re-runs) |
| `tracks` | `string[]` | Only run for these tracks |
| `conditions` | `string[]` | Only run when these conditions are selected |
| `agentName` | `string` | Override display name |
| `promptPath` | `string` | Override default prompt |

#### Module-Specific Options

| Option | Type | Description |
|--------|------|-------------|
| `loopSteps` | `number` | How many steps to go back when looping |
| `loopMaxIterations` | `number` | Maximum loop iterations |
| `loopSkip` | `string[]` | Agent IDs to skip when looping |

<Info>
  Modules are agents that can loop back to earlier steps. Use them for review cycles or iterative refinement.
</Info>

---

### Controller

Controllers are special agents that drive workflows autonomously. They can approve step transitions without user input.

```javascript
export default {
  name: 'My Workflow',
  controller: controller('my-controller-agent', { engine: 'claude' }),
  // ...
};
```

The controller agent needs access to workflow signals via MCP to approve transitions.

<Warning>
  Controllers are in beta. The workflow can still run without a controller in manual mode.
</Warning>

---

### Autonomous Mode

Control how the workflow runs:

| Value | Behavior |
|-------|----------|
| `'never'` | Always manual - user controls each step |
| `'always'` | Always autonomous - controller drives everything |
| `true` | Same as `'always'` |
| `false` | Same as `'never'` |

```javascript
export default {
  name: 'My Workflow',
  autonomousMode: 'never',
  // ...
};
```

<Tip>
  Users can toggle autonomous mode during workflow execution with `Shift+Tab`.
</Tip>

---

## Config Files Overview

The `config/` folder contains agent definitions and shared configuration:

| File | Purpose |
|------|---------|
| `main.agents.js` | Main agent definitions |
| `sub.agents.js` | Sub-agent definitions (optional) |
| `modules.js` | Module definitions for looping agents (optional) |
| `placeholders.js` | Dynamic content injection |
| `agent-characters.json` | Agent personalities and display styles |

<Card title="Build Agents" icon="robot" href="./build-agents">
  Learn how to configure agents in detail
</Card>

---

## Prompts Overview

The `prompts/templates/` folder contains all prompt files organized by agent:

```
prompts/templates/workflow-name/
├── agent-name/
│   ├── persona.md          # Agent personality
│   ├── workflow.md         # Main instructions
│   └── chained/            # Multi-step prompts
│       ├── step-01.md
│       └── step-02.md
└── shared/                 # Reusable across agents
    └── step-completion.md
```

<Card title="Write Prompts" icon="pen" href="./write-prompts">
  Learn how to write effective prompts
</Card>
